<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #6d6d6d; -webkit-text-stroke: #6d6d6d}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #a20010; -webkit-text-stroke: #a20010}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #1443ae; -webkit-text-stroke: #1443ae}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #12737e; -webkit-text-stroke: #12737e}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #156227; -webkit-text-stroke: #156227}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #2e3133; -webkit-text-stroke: #2e3133}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #4d5055; -webkit-text-stroke: #4d5055}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #6103ad; -webkit-text-stroke: #6103ad}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #2e3133; -webkit-text-stroke: #2e3133; min-height: 15.0px}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #093c94; -webkit-text-stroke: #093c94}
    p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #18191b; -webkit-text-stroke: #18191b}
    span.s1 {font-kerning: none; background-color: #f6f7f9}
    span.s2 {font-kerning: none; color: #fb0007; background-color: #f6f7f9; -webkit-text-stroke: 0px #fb0007}
    span.s3 {font-kerning: none; color: #2a2a2a; background-color: #f6f7f9; -webkit-text-stroke: 0px #2a2a2a}
    span.s4 {font-kerning: none; color: #1443ae; background-color: #f6f7f9; -webkit-text-stroke: 0px #1443ae}
    span.s5 {font-kerning: none; color: #2e3133; background-color: #f6f7f9; -webkit-text-stroke: 0px #2e3133}
    span.s6 {font-kerning: none; color: #12737e; background-color: #f6f7f9; -webkit-text-stroke: 0px #12737e}
    span.s7 {font-kerning: none; color: #a20010; background-color: #f6f7f9; -webkit-text-stroke: 0px #a20010}
    span.s8 {font-kerning: none; color: #6103ad; background-color: #f6f7f9; -webkit-text-stroke: 0px #6103ad}
    span.s9 {font-kerning: none; color: #137646; background-color: #f6f7f9; -webkit-text-stroke: 0px #137646}
    span.s10 {font-kerning: none; color: #093c94; background-color: #f6f7f9; -webkit-text-stroke: 0px #093c94}
    span.s11 {font-kerning: none; color: #4d5055; background-color: #f6f7f9; -webkit-text-stroke: 0px #4d5055}
    span.s12 {font-kerning: none}
    span.s13 {font-kerning: none; color: #156227; background-color: #f6f7f9; -webkit-text-stroke: 0px #156227}
    span.s14 {font-kerning: none; color: #18191b; background-color: #f6f7f9; -webkit-text-stroke: 0px #18191b}
    span.s15 {font-kerning: none; color: #ba0673; background-color: #f6f7f9; -webkit-text-stroke: 0px #ba0673}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE</span><span class="s2"> html</span><span class="s1">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s4">html</span><span class="s5"> </span><span class="s6">lang</span><span class="s3">=</span><span class="s1">"zh-TW"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">meta</span><span class="s5"> </span><span class="s1">charset</span><span class="s3">=</span><span class="s7">"UTF-8"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">meta</span><span class="s5"> </span><span class="s6">name</span><span class="s3">=</span><span class="s1">"viewport"</span><span class="s5"> </span><span class="s6">content</span><span class="s3">=</span><span class="s1">"width=device-width, initial-scale=1.0"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s1">title</span><span class="s3">&gt;</span><span class="s5">音準遊戲</span><span class="s3">&lt;/</span><span class="s1">title</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- Tailwind CSS CDN --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">script</span><span class="s5"> </span><span class="s6">src</span><span class="s3">=</span><span class="s1">"https://cdn.tailwindcss.com"</span><span class="s3">&gt;&lt;/</span><span class="s4">script</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- Font Awesome for icons --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">link</span><span class="s5"> </span><span class="s6">rel</span><span class="s3">=</span><span class="s1">"stylesheet"</span><span class="s5"> </span><span class="s6">href</span><span class="s3">=</span><span class="s1">"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s8">body</span><span class="s1"> {</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">font-family:</span><span class="s5"> </span><span class="s1">'Inter'</span><span class="s5">, </span><span class="s1">sans-serif</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s5"> </span><span class="s7">linear-gradient(</span><span class="s9">135deg</span><span class="s5">, </span><span class="s10">#a8c0ff</span><span class="s5">, </span><span class="s10">#3f2b96</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Gradient background */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">display:</span><span class="s1"> </span><span class="s7">flex</span><span class="s1">;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">align-items:</span><span class="s1"> </span><span class="s7">center</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">min-height:</span><span class="s1"> </span><span class="s9">100vh</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin:</span><span class="s1"> </span><span class="s9">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">padding:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-sizing:</span><span class="s1"> </span><span class="s7">border-box</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s10">#fff</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">text-shadow:</span><span class="s1"> </span><span class="s9">1px</span><span class="s1"> </span><span class="s9">1px</span><span class="s1"> </span><span class="s9">2px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0.3</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.game-container</span><span class="s5"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background-color:</span><span class="s5"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s5">, </span><span class="s9">255</span><span class="s5">, </span><span class="s9">255</span><span class="s5">, </span><span class="s9">0.15</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Semi-transparent white */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">padding:</span><span class="s1"> </span><span class="s9">30px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">10px</span><span class="s1"> </span><span class="s9">30px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0.3</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">text-align:</span><span class="s1"> </span><span class="s7">center</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">max-width:</span><span class="s1"> </span><span class="s9">600px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border:</span><span class="s1"> </span><span class="s9">1px</span><span class="s1"> </span><span class="s7">solid</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">0.3</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">backdrop-filter:</span><span class="s5"> </span><span class="s7">blur(</span><span class="s9">10px</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Frosted glass effect */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s8">.btn</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s1"> </span><span class="s7">linear-gradient(</span><span class="s9">135deg</span><span class="s1">, </span><span class="s10">#6a11cb</span><span class="s1"> </span><span class="s9">0%</span><span class="s1">, </span><span class="s10">#2575fc</span><span class="s1"> </span><span class="s9">100%</span><span class="s7">)</span><span class="s1">; </span><span class="s11">/* Gradient button */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s7">white</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">padding:</span><span class="s1"> </span><span class="s9">12px</span><span class="s1"> </span><span class="s9">25px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">cursor:</span><span class="s1"> </span><span class="s7">pointer</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">transition:</span><span class="s1"> </span><span class="s7">all</span><span class="s1"> </span><span class="s9">0.3s</span><span class="s1"> </span><span class="s7">ease</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border:</span><span class="s1"> </span><span class="s7">none</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-weight:</span><span class="s1"> </span><span class="s7">bold</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">4px</span><span class="s1"> </span><span class="s9">15px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0.2</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s8">.btn:hover</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">transform:</span><span class="s1"> </span><span class="s7">translateY(</span><span class="s9">-3px</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">6px</span><span class="s1"> </span><span class="s9">20px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0.3</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s1"> </span><span class="s7">linear-gradient(</span><span class="s9">135deg</span><span class="s1">, </span><span class="s10">#2575fc</span><span class="s1"> </span><span class="s9">0%</span><span class="s1">, </span><span class="s10">#6a11cb</span><span class="s1"> </span><span class="s9">100%</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.btn:disabled</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s1"> </span><span class="s10">#ccc</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">cursor:</span><span class="s1"> </span><span class="s7">not-allowed</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">opacity:</span><span class="s1"> </span><span class="s9">0.7</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">transform:</span><span class="s1"> </span><span class="s7">none</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s7">none</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.progress-bar-container</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background-color:</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">0.2</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">overflow:</span><span class="s1"> </span><span class="s7">hidden</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-top:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s7">inset</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">2px</span><span class="s1"> </span><span class="s9">5px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0.2</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.progress-bar</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">0%</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s5"> </span><span class="s7">linear-gradient(</span><span class="s9">90deg</span><span class="s5">, </span><span class="s10">#ff7e5f</span><span class="s5">, </span><span class="s10">#feb47b</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Progress bar gradient */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">transition:</span><span class="s1"> </span><span class="s7">width</span><span class="s1"> </span><span class="s9">0.5s</span><span class="s1"> </span><span class="s7">ease-in-out</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.note-display</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-size:</span><span class="s1"> </span><span class="s9">4rem</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-weight:</span><span class="s1"> </span><span class="s7">bold</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin:</span><span class="s1"> </span><span class="s9">30px</span><span class="s1"> </span><span class="s9">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s10">#fff</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">animation:</span><span class="s5"> </span><span class="s7">pulse</span><span class="s5"> </span><span class="s9">1.5s</span><span class="s5"> </span><span class="s7">infinite</span><span class="s5"> </span><span class="s7">alternate</span><span class="s5">; </span><span class="s1">/* Pulsing animation for note */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">@keyframes</span><span class="s1"> </span><span class="s7">pulse</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s9">0%</span><span class="s1"> { </span><span class="s6">transform:</span><span class="s1"> </span><span class="s7">scale(</span><span class="s9">1</span><span class="s7">)</span><span class="s1">; </span><span class="s6">text-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">10px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s1">,</span><span class="s9">255</span><span class="s1">,</span><span class="s9">255</span><span class="s1">,</span><span class="s9">0.5</span><span class="s7">)</span><span class="s1">; }</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s9">100%</span><span class="s1"> { </span><span class="s6">transform:</span><span class="s1"> </span><span class="s7">scale(</span><span class="s9">1.05</span><span class="s7">)</span><span class="s1">; </span><span class="s6">text-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">20px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s1">,</span><span class="s9">255</span><span class="s1">,</span><span class="s9">255</span><span class="s1">,</span><span class="s9">0.8</span><span class="s7">)</span><span class="s1">; }</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.feedback-message</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-size:</span><span class="s1"> </span><span class="s9">1.5rem</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-top:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-weight:</span><span class="s1"> </span><span class="s7">bold</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.feedback-success</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s10">#4CAF50</span><span class="s1">; </span><span class="s11">/* Green */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.feedback-fail</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s10">#F44336</span><span class="s1">; </span><span class="s11">/* Red */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.guess-options</span><span class="s5"> </span><span class="s1">button</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-bottom:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-size:</span><span class="s1"> </span><span class="s9">1.2rem</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">/* Modal styling */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s8">.modal</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">position:</span><span class="s1"> </span><span class="s7">fixed</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">top:</span><span class="s1"> </span><span class="s9">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">left:</span><span class="s1"> </span><span class="s9">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background-color:</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0.7</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">display:</span><span class="s1"> </span><span class="s7">flex</span><span class="s1">;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">align-items:</span><span class="s1"> </span><span class="s7">center</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">z-index:</span><span class="s1"> </span><span class="s9">1000</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.modal-content</span><span class="s5"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s5"> </span><span class="s7">linear-gradient(</span><span class="s9">135deg</span><span class="s5">, </span><span class="s10">#4CAF50</span><span class="s5">, </span><span class="s10">#8BC34A</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Green gradient */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s7">white</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">padding:</span><span class="s1"> </span><span class="s9">30px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">text-align:</span><span class="s1"> </span><span class="s7">center</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">max-width:</span><span class="s1"> </span><span class="s9">400px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">90%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">10px</span><span class="s1"> </span><span class="s9">30px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0.4</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">animation:</span><span class="s1"> </span><span class="s7">fadeIn</span><span class="s1"> </span><span class="s9">0.3s</span><span class="s1"> </span><span class="s7">ease-out</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.modal-fail</span><span class="s5"> </span><span class="s1">.modal-content</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s1"> </span><span class="s7">linear-gradient(</span><span class="s9">135deg</span><span class="s1">, </span><span class="s10">#F44336</span><span class="s1">, </span><span class="s10">#FF9800</span><span class="s7">)</span><span class="s1">; </span><span class="s11">/* Red gradient */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">@keyframes</span><span class="s1"> </span><span class="s7">fadeIn</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">from</span><span class="s1"> { </span><span class="s6">opacity:</span><span class="s1"> </span><span class="s9">0</span><span class="s1">; </span><span class="s6">transform:</span><span class="s1"> </span><span class="s7">scale(</span><span class="s9">0.9</span><span class="s7">)</span><span class="s1">; }</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s7">to</span><span class="s1"> { </span><span class="s6">opacity:</span><span class="s1"> </span><span class="s9">1</span><span class="s1">; </span><span class="s6">transform:</span><span class="s1"> </span><span class="s7">scale(</span><span class="s9">1</span><span class="s7">)</span><span class="s1">; }</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s8">.ai-feedback-area</span><span class="s5"> { </span><span class="s1">/* Kept for general styling, but removed functionality */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background-color:</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0</span><span class="s1">, </span><span class="s9">0.2</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">padding:</span><span class="s1"> </span><span class="s9">15px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-top:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">min-height:</span><span class="s1"> </span><span class="s9">50px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">display:</span><span class="s1"> </span><span class="s7">flex</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">align-items:</span><span class="s1"> </span><span class="s7">center</span><span class="s1">;</span></p>
<p class="p4"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">justify-content:</span><span class="s5"> </span><span class="s7">center</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-size:</span><span class="s1"> </span><span class="s9">1rem</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s1"> </span><span class="s10">#eee</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.countdown-display</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-size:</span><span class="s1"> </span><span class="s9">2.5rem</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">font-weight:</span><span class="s1"> </span><span class="s7">bold</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">color:</span><span class="s5"> </span><span class="s10">#ffeb3b</span><span class="s5">; </span><span class="s1">/* Yellow for countdown */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-top:</span><span class="s1"> </span><span class="s9">15px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">text-shadow:</span><span class="s1"> </span><span class="s9">2px</span><span class="s1"> </span><span class="s9">2px</span><span class="s1"> </span><span class="s9">5px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0.5</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.volume-meter-container</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">20px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">background-color:</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">0.3</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">overflow:</span><span class="s1"> </span><span class="s7">hidden</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-top:</span><span class="s1"> </span><span class="s9">15px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border:</span><span class="s1"> </span><span class="s9">1px</span><span class="s1"> </span><span class="s7">solid</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">255</span><span class="s1">, </span><span class="s9">0.5</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.volume-bar</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">0%</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s5"> </span><span class="s7">linear-gradient(</span><span class="s9">90deg</span><span class="s5">, </span><span class="s10">#4CAF50</span><span class="s5">, </span><span class="s10">#8BC34A</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Green gradient for volume */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">transition:</span><span class="s5"> </span><span class="s7">width</span><span class="s5"> </span><span class="s9">0.1s</span><span class="s5"> </span><span class="s7">ease-out</span><span class="s5">; </span><span class="s1">/* Smooth transition for volume changes */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">/* Pitch Indicator Styles */</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.pitch-indicator-container</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">15px</span><span class="s1">;</span></p>
<p class="p10"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background:</span><span class="s5"> </span><span class="s7">linear-gradient(to</span><span class="s5"> </span><span class="s7">right</span><span class="s5">, </span><span class="s1">#f44336</span><span class="s5">, </span><span class="s1">#ffeb3b</span><span class="s5">, </span><span class="s1">#4CAF50</span><span class="s5">, </span><span class="s1">#ffeb3b</span><span class="s5">, </span><span class="s1">#f44336</span><span class="s7">)</span><span class="s5">; </span><span class="s11">/* Red-Yellow-Green-Yellow-Red */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">10px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">margin-top:</span><span class="s1"> </span><span class="s9">15px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">position:</span><span class="s1"> </span><span class="s7">relative</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s7">inset</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">2px</span><span class="s1"> </span><span class="s9">5px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0.2</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">overflow:</span><span class="s5"> </span><span class="s7">hidden</span><span class="s5">; </span><span class="s1">/* Ensure marker stays within bounds */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p8"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">.pitch-marker</span><span class="s5"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">position:</span><span class="s1"> </span><span class="s7">absolute</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">top:</span><span class="s1"> </span><span class="s9">0</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">left:</span><span class="s5"> </span><span class="s9">50%</span><span class="s5">; </span><span class="s1">/* Start in the middle */</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">transform:</span><span class="s5"> </span><span class="s7">translateX(</span><span class="s9">-50%</span><span class="s7">)</span><span class="s5">; </span><span class="s1">/* Center the marker */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">width:</span><span class="s1"> </span><span class="s9">8px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">height:</span><span class="s1"> </span><span class="s9">100%</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">background-color:</span><span class="s5"> </span><span class="s10">#fff</span><span class="s5">; </span><span class="s1">/* White marker */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">border-radius:</span><span class="s1"> </span><span class="s9">2px</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s6">box-shadow:</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">5px</span><span class="s1"> </span><span class="s7">rgba(</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0</span><span class="s1">,</span><span class="s9">0.5</span><span class="s7">)</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">transition:</span><span class="s5"> </span><span class="s7">left</span><span class="s5"> </span><span class="s9">0.05s</span><span class="s5"> </span><span class="s7">linear</span><span class="s5">; </span><span class="s1">/* Smooth movement */</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s6">z-index:</span><span class="s5"> </span><span class="s9">1</span><span class="s5">; </span><span class="s1">/* Ensure it's above the gradient */</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;/</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"game-container"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">h1</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-4xl font-extrabold mb-8"</span><span class="s3">&gt;</span><span class="s5">音準遊戲</span><span class="s3">&lt;/</span><span class="s4">h1</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">&lt;!-- Start Screen --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"start-screen"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"p-4"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"mb-6"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">label</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"block text-xl font-semibold mb-3"</span><span class="s3">&gt;</span><span class="s5">選擇難易度 (遊戲模式):</span><span class="s3">&lt;/</span><span class="s4">label</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"flex flex-col space-y-3"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">label</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"inline-flex items-center"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s3">&lt;</span><span class="s4">input</span><span class="s5"> </span><span class="s6">type</span><span class="s3">=</span><span class="s1">"radio"</span><span class="s5"> </span><span class="s6">name</span><span class="s3">=</span><span class="s1">"difficulty"</span><span class="s5"> </span><span class="s6">value</span><span class="s3">=</span><span class="s1">"easy"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"form-radio text-blue-600 h-5 w-5"</span><span class="s5"> </span><span class="s6">checked</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"ml-2 text-lg"</span><span class="s3">&gt;</span><span class="s1">簡單 (較寬容的音高範圍)</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;/</span><span class="s4">label</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">label</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"inline-flex items-center"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s3">&lt;</span><span class="s4">input</span><span class="s5"> </span><span class="s6">type</span><span class="s3">=</span><span class="s1">"radio"</span><span class="s5"> </span><span class="s6">name</span><span class="s3">=</span><span class="s1">"difficulty"</span><span class="s5"> </span><span class="s6">value</span><span class="s3">=</span><span class="s1">"medium"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"form-radio text-purple-600 h-5 w-5"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"ml-2 text-lg"</span><span class="s3">&gt;</span><span class="s1">中等 (適度的音高範圍)</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;/</span><span class="s4">label</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">label</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"inline-flex items-center"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s3">&lt;</span><span class="s4">input</span><span class="s5"> </span><span class="s6">type</span><span class="s3">=</span><span class="s1">"radio"</span><span class="s5"> </span><span class="s6">name</span><span class="s3">=</span><span class="s1">"difficulty"</span><span class="s5"> </span><span class="s6">value</span><span class="s3">=</span><span class="s1">"hard"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"form-radio text-red-600 h-5 w-5"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"ml-2 text-lg"</span><span class="s3">&gt;</span><span class="s1">困難 (嚴格的音高範圍)</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;/</span><span class="s4">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"mb-8"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">label</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"inline-flex items-center"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">input</span><span class="s5"> </span><span class="s6">type</span><span class="s3">=</span><span class="s1">"checkbox"</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"guess-mode-toggle"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"form-checkbox text-green-600 h-5 w-5"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">span</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"ml-2 text-lg"</span><span class="s3">&gt;</span><span class="s1">啟用猜音高模式 (遊戲模式下沒有麥克風)</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;/</span><span class="s4">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"start-game-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn"</span><span class="s3">&gt;</span><span class="s5">開始遊戲</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s7">"start-tuner-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"btn mt-4"</span><span class="s3">&gt;</span><span class="s5">啟動調音器</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s1">&lt;!-- New Tuner Mode Button --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"mic-status"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-sm mt-4 text-yellow-300 hidden"</span><span class="s3">&gt;&lt;</span><span class="s4">i</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"fas fa-exclamation-triangle"</span><span class="s3">&gt;&lt;/</span><span class="s4">i</span><span class="s3">&gt;</span><span class="s5"> 麥克風權限待確認或未獲取。</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-sm mt-4 text-gray-300"</span><span class="s3">&gt;</span><span class="s5">作者: 亭竹</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s13">&lt;!-- Author info --&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">&lt;!-- Game Screen --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"game-screen"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"p-4 hidden"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-xl font-semibold mb-4"</span><span class="s3">&gt;&lt;</span><span class="s4">span</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"mode-display"</span><span class="s3">&gt;&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s3">&lt;</span><span class="s4">span</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"current-level-text"</span><span class="s3">&gt;&lt;/</span><span class="s4">span</span><span class="s3">&gt;&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"progress-bar-container mb-6"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"progress-bar"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"progress-bar"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-2xl font-bold mb-4"</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"target-note-label"</span><span class="s3">&gt;</span><span class="s5">目標音高:</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"target-note"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"note-display"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"play-note-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn mb-4"</span><span class="s3">&gt;&lt;</span><span class="s4">i</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"fas fa-play"</span><span class="s3">&gt;&lt;/</span><span class="s4">i</span><span class="s3">&gt;</span><span class="s5"> 播放目標音高</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">&lt;!-- Countdown Display --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"countdown-display"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"countdown-display hidden"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s13">&lt;!-- Initial value set by JS --&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">&lt;!-- Microphone Input Area --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"mic-input-area"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-2xl font-bold mb-2"</span><span class="s3">&gt;</span><span class="s5">您正在唱:</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"detected-note"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"note-display text-gray-300"</span><span class="s3">&gt;</span><span class="s5">--</span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">&lt;!-- Volume Meter --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"volume-meter"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"volume-meter-container hidden"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"volume-bar"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"volume-bar"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">&lt;!-- Pitch Indicator --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"pitch-indicator-container"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"pitch-indicator-container hidden"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"pitch-marker"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"pitch-marker"</span><span class="s3">&gt;&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">&lt;!-- Guess Mode Area --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"guess-mode-area"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"hidden guess-options grid grid-cols-1 md:grid-cols-3 gap-4 mt-6"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn guess-option-btn"</span><span class="s5"> </span><span class="s6">data-midi-note</span><span class="s3">=</span><span class="s1">"0"</span><span class="s3">&gt;&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn guess-option-btn"</span><span class="s5"> </span><span class="s6">data-midi-note</span><span class="s3">=</span><span class="s1">"0"</span><span class="s3">&gt;&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn guess-option-btn"</span><span class="s5"> </span><span class="s6">data-midi-note</span><span class="s3">=</span><span class="s1">"0"</span><span class="s3">&gt;&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"feedback-message"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"feedback-message mt-6"</span><span class="s3">&gt;&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s7">"return-to-main-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"btn mt-6 hidden"</span><span class="s3">&gt;</span><span class="s5">返回主頁</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s1">&lt;!-- New Return button for Tuner Mode --&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">&lt;!-- End Screen --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"end-screen"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"p-4 hidden"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">h2</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-3xl font-extrabold mb-6"</span><span class="s3">&gt;</span><span class="s5">遊戲結束！</span><span class="s3">&lt;/</span><span class="s4">h2</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-2xl mb-8"</span><span class="s3">&gt;</span><span class="s5">您的分數: </span><span class="s3">&lt;</span><span class="s4">span</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"final-score"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"font-bold"</span><span class="s3">&gt;</span><span class="s5">0</span><span class="s3">&lt;/</span><span class="s4">span</span><span class="s3">&gt;</span><span class="s5"> / 10</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"restart-game-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn"</span><span class="s3">&gt;</span><span class="s5">重新開始</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"return-from-end-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn mt-4"</span><span class="s3">&gt;</span><span class="s5">返回主頁</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- Modals --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"pass-modal"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"modal hidden"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"modal-content"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">i</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"fas fa-check-circle text-6xl mb-4"</span><span class="s3">&gt;&lt;/</span><span class="s4">i</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">h3</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-3xl font-bold mb-2"</span><span class="s3">&gt;</span><span class="s5">太棒了！</span><span class="s3">&lt;/</span><span class="s4">h3</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s1"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"text-xl mb-4"</span><span class="s3">&gt;</span><span class="s1">您通過了這一關！</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"next-level-pass-modal-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn"</span><span class="s3">&gt;</span><span class="s5">下一關</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s13">&lt;!-- Changed ID --&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"fail-modal"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"modal hidden modal-fail"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s4">div</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"modal-content"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">i</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"fas fa-times-circle text-6xl mb-4"</span><span class="s3">&gt;&lt;/</span><span class="s4">i</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">h3</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"text-3xl font-bold mb-2"</span><span class="s3">&gt;</span><span class="s5">喔不！</span><span class="s3">&lt;/</span><span class="s4">h3</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">p</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s7">"text-xl mb-4"</span><span class="s3">&gt;</span><span class="s5">挑戰失敗。</span><span class="s3">&lt;/</span><span class="s4">p</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s1">&lt;!-- Removed "請再試一次" --&gt;</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s4">button</span><span class="s5"> </span><span class="s6">id</span><span class="s3">=</span><span class="s1">"next-level-fail-modal-btn"</span><span class="s5"> </span><span class="s6">class</span><span class="s3">=</span><span class="s1">"btn"</span><span class="s3">&gt;</span><span class="s5">下一關</span><span class="s3">&lt;/</span><span class="s4">button</span><span class="s3">&gt;</span><span class="s5"> </span><span class="s13">&lt;!-- Changed ID and text --&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s4">div</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s4">script</span><span class="s5"> </span><span class="s6">type</span><span class="s3">=</span><span class="s1">"module"</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Firebase imports</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">import</span><span class="s5"> { </span><span class="s14">initializeApp</span><span class="s5"> } </span><span class="s4">from</span><span class="s5"> </span><span class="s1">"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">import</span><span class="s5"> { </span><span class="s1">getAuth</span><span class="s5">, </span><span class="s1">signInAnonymously</span><span class="s5">, </span><span class="s1">signInWithCustomToken</span><span class="s5">, </span><span class="s1">onAuthStateChanged</span><span class="s5"> } </span><span class="s4">from</span><span class="s5"> </span><span class="s7">"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// No Firestore needed for this app as no persistence is required.</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Firebase Initialization (boilerplate)</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">appId</span><span class="s5"> = </span><span class="s4">typeof</span><span class="s5"> </span><span class="s14">__app_id</span><span class="s5"> !== </span><span class="s1">'undefined'</span><span class="s5"> ? </span><span class="s14">__app_id</span><span class="s5"> : </span><span class="s1">'default-app-id'</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">firebaseConfig</span><span class="s5"> = </span><span class="s4">typeof</span><span class="s5"> </span><span class="s1">__firebase_config</span><span class="s5"> !== </span><span class="s7">'undefined'</span><span class="s5"> ? </span><span class="s15">JSON</span><span class="s5">.</span><span class="s1">parse</span><span class="s5">(</span><span class="s1">__firebase_config</span><span class="s5">) : {};</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">app</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">auth</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// userId is no longer displayed, but Firebase auth is still initialized for environment consistency.</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// --- Game Logic Variables ---</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Moved all game logic variables to the top for clarity and to prevent ReferenceErrors.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">audioContext</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">analyser</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">microphone</span><span class="s1">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">scriptProcessor</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">targetMidiNote</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">countdownTimer</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">countdownValue</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">currentLevel</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">score</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">difficultyTolerance</span><span class="s5"> = {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">easy</span><span class="s5">: </span><span class="s6">0.5</span><span class="s5">, <span class="Apple-converted-space">  </span></span><span class="s1">// +/- 0.5 semitones</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">medium</span><span class="s5">: </span><span class="s6">0.25</span><span class="s5">, </span><span class="s1">// +/- 0.25 semitones</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">hard</span><span class="s5">: </span><span class="s6">0.22</span><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s1">// Changed to 0.22 for a slightly simpler hard mode, closer to medium</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">difficultyCountdown</span><span class="s5"> = { </span><span class="s1">// Countdown times based on difficulty</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">easy</span><span class="s1">: </span><span class="s6">6</span><span class="s1">,</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">medium</span><span class="s1">: </span><span class="s6">5</span><span class="s1">,</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">hard</span><span class="s1">: </span><span class="s6">2</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">currentTolerance</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">guessMode</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// True if in guess mode, false if in mic mode (for game)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// True if a game level is active</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">tunerModeActive</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// True if in tuner mode</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">activeOscillators</span><span class="s5"> = []; </span><span class="s1">// To hold multiple oscillators for piano-like sound</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Initialize Firebase and authenticate</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">try</span><span class="s1"> {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">app</span><span class="s5"> = </span><span class="s1">initializeApp</span><span class="s5">(</span><span class="s1">firebaseConfig</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">auth</span><span class="s1"> = </span><span class="s14">getAuth</span><span class="s1">(</span><span class="s14">app</span><span class="s1">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Listen for auth state changes (though userId is not displayed)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">onAuthStateChanged</span><span class="s5">(</span><span class="s1">auth</span><span class="s5">, </span><span class="s4">async</span><span class="s5"> (</span><span class="s1">user</span><span class="s5">) =&gt; {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (!</span><span class="s14">user</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s4">await</span><span class="s1"> </span><span class="s14">signInAnonymously</span><span class="s1">(</span><span class="s14">auth</span><span class="s1">).</span><span class="s4">catch</span><span class="s1">(</span><span class="s14">error</span><span class="s1"> =&gt; {</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s14">console</span><span class="s5">.</span><span class="s14">error</span><span class="s5">(</span><span class="s1">"Firebase anonymous sign-in failed during onAuthStateChanged:"</span><span class="s5">, </span><span class="s14">error</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span>});</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Initial sign-in attempt: Prioritize custom token if available.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// This error (auth/invalid-claims) is often expected if the provided custom token is not valid in this environment,</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// and the app correctly falls back to anonymous sign-in. It's not a critical application error.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s4">typeof</span><span class="s5"> </span><span class="s1">__initial_auth_token</span><span class="s5"> !== </span><span class="s7">'undefined'</span><span class="s5"> &amp;&amp; </span><span class="s1">__initial_auth_token</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">signInWithCustomToken</span><span class="s5">(</span><span class="s1">auth</span><span class="s5">, </span><span class="s1">__initial_auth_token</span><span class="s5">).</span><span class="s4">catch</span><span class="s5">(</span><span class="s1">error</span><span class="s5"> =&gt; {</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s14">console</span><span class="s5">.</span><span class="s14">error</span><span class="s5">(</span><span class="s1">"Firebase custom token sign-in failed (might be invalid or expired, continuing with anonymous user):"</span><span class="s5">, </span><span class="s14">error</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>});</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                 </span></span><span class="s14">signInAnonymously</span><span class="s1">(</span><span class="s14">auth</span><span class="s1">).</span><span class="s4">catch</span><span class="s1">(</span><span class="s14">error</span><span class="s1"> =&gt; {</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s14">console</span><span class="s5">.</span><span class="s14">error</span><span class="s5">(</span><span class="s1">"Firebase anonymous sign-in failed (no custom token provided):"</span><span class="s5">, </span><span class="s14">error</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                 </span>});</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>} </span><span class="s4">catch</span><span class="s1"> (</span><span class="s14">error</span><span class="s1">) {</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">console</span><span class="s5">.</span><span class="s14">error</span><span class="s5">(</span><span class="s1">"Failed to initialize Firebase:"</span><span class="s5">, </span><span class="s14">error</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// --- DOM Elements ---</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">startScreen</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'start-screen'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">gameScreen</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'game-screen'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">endScreen</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'end-screen'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">startGameBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'start-game-btn'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">startTunerBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'start-tuner-btn'</span><span class="s5">); </span><span class="s11">// New Tuner button</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">restartGameBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'restart-game-btn'</span><span class="s5">);</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">returnFromEndBtn</span><span class="s5"> = </span><span class="s14">document</span><span class="s5">.</span><span class="s14">getElementById</span><span class="s5">(</span><span class="s7">'return-from-end-btn'</span><span class="s5">); </span><span class="s1">// New button to return from end screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">guessModeToggle</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'guess-mode-toggle'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">micInputArea</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'mic-input-area'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">guessModeArea</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'guess-mode-area'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">playNoteBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'play-note-btn'</span><span class="s5">);</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">currentLevelText</span><span class="s5"> = </span><span class="s14">document</span><span class="s5">.</span><span class="s14">getElementById</span><span class="s5">(</span><span class="s7">'current-level-text'</span><span class="s5">); </span><span class="s1">// Renamed current-level to current-level-text</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">modeDisplay</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'mode-display'</span><span class="s5">); </span><span class="s11">// To show "遊戲模式" or "調音器模式"</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">progressBar</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'progress-bar'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetNoteDisplay</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'target-note'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetNoteLabel</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'target-note-label'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">detectedNoteDisplay</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'detected-note'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">feedbackMessage</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'feedback-message'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">finalScoreDisplay</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'final-score'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">micStatusDisplay</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'mic-status'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">countdownDisplay</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'countdown-display'</span><span class="s5">); </span><span class="s11">// Countdown element</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">volumeMeter</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'volume-meter'</span><span class="s5">); </span><span class="s11">// Volume meter container</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">volumeBar</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'volume-bar'</span><span class="s5">); <span class="Apple-converted-space">    </span></span><span class="s11">// Volume bar itself</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">pitchIndicatorContainer</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'pitch-indicator-container'</span><span class="s5">); </span><span class="s11">// Pitch indicator container</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">pitchMarker</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'pitch-marker'</span><span class="s5">); </span><span class="s11">// Pitch marker</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">returnToMainBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'return-to-main-btn'</span><span class="s5">); </span><span class="s11">// New Return button for Tuner Mode</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">passModal</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'pass-modal'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">failModal</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'fail-modal'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">nextLevelPassModalBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'next-level-pass-modal-btn'</span><span class="s5">); </span><span class="s11">// Renamed</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">nextLevelFailModalBtn</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">getElementById</span><span class="s5">(</span><span class="s7">'next-level-fail-modal-btn'</span><span class="s5">); </span><span class="s11">// Renamed</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// AI feedback elements (removed functionality, kept for reference if needed for layout)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// const passAiFeedbackArea = document.getElementById('pass-ai-feedback-area'); // Already removed from DOM in previous update</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// const failAiFeedbackArea = document.getElementById('fail-ai-feedback-area'); // Already removed from DOM in previous update</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// --- Utility Functions ---</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Converts MIDI note number to frequency (Hz).</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} midiNote - MIDI note number (e.g., 60 for C4, 69 for A4).</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @returns {number} Frequency in Hz.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">midiToFreq</span><span class="s5">(</span><span class="s1">midiNote</span><span class="s5">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">return</span><span class="s1"> </span><span class="s6">440</span><span class="s1"> * </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">pow</span><span class="s1">(</span><span class="s6">2</span><span class="s1">, (</span><span class="s14">midiNote</span><span class="s1"> - </span><span class="s6">69</span><span class="s1">) / </span><span class="s6">12</span><span class="s1">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Converts frequency (Hz) to the nearest MIDI note number.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} frequency - Frequency in Hz.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @returns {number} Nearest MIDI note number.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">freqToMidi</span><span class="s5">(</span><span class="s1">frequency</span><span class="s5">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">frequency</span><span class="s1"> &lt;= </span><span class="s6">0</span><span class="s1">) </span><span class="s4">return</span><span class="s1"> </span><span class="s6">0</span><span class="s1">; </span><span class="s11">// Avoid log(0)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">return</span><span class="s1"> </span><span class="s6">12</span><span class="s1"> * (</span><span class="s15">Math</span><span class="s1">.</span><span class="s14">log</span><span class="s1">(</span><span class="s14">frequency</span><span class="s1"> / </span><span class="s6">440</span><span class="s1">) / </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">log</span><span class="s1">(</span><span class="s6">2</span><span class="s1">)) + </span><span class="s6">69</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Converts MIDI note number to a musical note string (e.g., "C4", "G#3").</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Ensures that the MIDI note is rounded to the nearest integer before conversion to avoid fractional notes.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} midiNote - MIDI note number.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @returns {string} Musical note string.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">midiNoteToName</span><span class="s5">(</span><span class="s1">midiNote</span><span class="s5">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">noteNames</span><span class="s1"> = [</span><span class="s7">"C"</span><span class="s1">, </span><span class="s7">"C#"</span><span class="s1">, </span><span class="s7">"D"</span><span class="s1">, </span><span class="s7">"D#"</span><span class="s1">, </span><span class="s7">"E"</span><span class="s1">, </span><span class="s7">"F"</span><span class="s1">, </span><span class="s7">"F#"</span><span class="s1">, </span><span class="s7">"G"</span><span class="s1">, </span><span class="s7">"G#"</span><span class="s1">, </span><span class="s7">"A"</span><span class="s1">, </span><span class="s7">"A#"</span><span class="s1">, </span><span class="s7">"B"</span><span class="s1">];</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">roundedMidiNote</span><span class="s5"> = </span><span class="s15">Math</span><span class="s5">.</span><span class="s14">round</span><span class="s5">(</span><span class="s14">midiNote</span><span class="s5">); </span><span class="s1">// Round to nearest integer for display</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Handle edge cases for octaves that might go out of standard range for display</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">octave</span><span class="s1"> = </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">floor</span><span class="s1">(</span><span class="s14">roundedMidiNote</span><span class="s1"> / </span><span class="s6">12</span><span class="s1">) - </span><span class="s6">1</span><span class="s1">; </span><span class="s11">// MIDI 0 = C-1</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">octave</span><span class="s5"> &lt; -</span><span class="s6">1</span><span class="s5">) </span><span class="s14">octave</span><span class="s5"> = -</span><span class="s6">1</span><span class="s5">; </span><span class="s1">// Clamp lower octave to C-1</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">octave</span><span class="s5"> &gt; </span><span class="s6">8</span><span class="s5">) </span><span class="s14">octave</span><span class="s5"> = </span><span class="s6">8</span><span class="s5">; </span><span class="s1">// Clamp higher octave to C8 (or whatever highest desired)</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">noteIndex</span><span class="s5"> = (</span><span class="s14">roundedMidiNote</span><span class="s5"> % </span><span class="s6">12</span><span class="s5"> + </span><span class="s6">12</span><span class="s5">) % </span><span class="s6">12</span><span class="s5">; </span><span class="s1">// Ensure positive modulo result</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">return</span><span class="s5"> </span><span class="s1">noteNames</span><span class="s5">[</span><span class="s1">noteIndex</span><span class="s5">] + </span><span class="s1">octave</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Plays a specified MIDI note using multiple OscillatorNodes for a piano-like sound.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Includes a simple ADSR envelope for decay.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} midiNote - The MIDI note to play.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">playNote</span><span class="s5">(</span><span class="s1">midiNote</span><span class="s5">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Stop any currently active oscillators</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">activeOscillators</span><span class="s5">.</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">osc</span><span class="s5"> =&gt; {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">try</span><span class="s1"> {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">osc</span><span class="s1">.</span><span class="s14">stop</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">osc</span><span class="s1">.</span><span class="s14">disconnect</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s4">catch</span><span class="s1"> (</span><span class="s14">e</span><span class="s1">) {</span></p>
<p class="p2"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s14">console</span><span class="s5">.</span><span class="s14">warn</span><span class="s5">(</span><span class="s1">"Error stopping oscillator:"</span><span class="s5">, </span><span class="s14">e</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">activeOscillators</span><span class="s1"> = [];</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (!</span><span class="s14">audioContext</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                 </span></span><span class="s1">audioContext</span><span class="s5"> = </span><span class="s4">new</span><span class="s5"> (</span><span class="s1">window</span><span class="s5">.</span><span class="s15">AudioContext</span><span class="s5"> || </span><span class="s1">window</span><span class="s5">.</span><span class="s1">webkitAudioContext</span><span class="s5">)();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">now</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">currentTime</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">fundamentalFreq</span><span class="s5"> = </span><span class="s1">midiToFreq</span><span class="s5">(</span><span class="s1">midiNote</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Master gain for the note</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">masterGain</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createGain</span><span class="s5">();</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">masterGain</span><span class="s5">.</span><span class="s1">connect</span><span class="s5">(</span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">destination</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">masterGain</span><span class="s5">.</span><span class="s1">gain</span><span class="s5">.</span><span class="s1">setValueAtTime</span><span class="s5">(</span><span class="s6">0</span><span class="s5">, </span><span class="s1">now</span><span class="s5">); </span><span class="s11">// Start from 0 gain</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Simple Attack-Decay-Sustain-Release (ADSR) envelope</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">attackTime</span><span class="s1"> = </span><span class="s6">0.02</span><span class="s1">; </span><span class="s11">// Quick attack</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">decayTime</span><span class="s1"> = </span><span class="s6">0.5</span><span class="s1">; <span class="Apple-converted-space">  </span></span><span class="s11">// Medium decay</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">sustainLevel</span><span class="s5"> = </span><span class="s6">0.3</span><span class="s5">; </span><span class="s1">// Sustain at 30% of max</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">releaseTime</span><span class="s5"> = </span><span class="s6">1.0</span><span class="s5">;<span class="Apple-converted-space">  </span></span><span class="s1">// Long release for piano-like tail</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s11">// Attack</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">masterGain</span><span class="s5">.</span><span class="s1">gain</span><span class="s5">.</span><span class="s1">linearRampToValueAtTime</span><span class="s5">(</span><span class="s6">0.7</span><span class="s5">, </span><span class="s1">now</span><span class="s5"> + </span><span class="s1">attackTime</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s11">// Decay</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">masterGain</span><span class="s5">.</span><span class="s1">gain</span><span class="s5">.</span><span class="s1">linearRampToValueAtTime</span><span class="s5">(</span><span class="s1">sustainLevel</span><span class="s5"> * </span><span class="s6">0.7</span><span class="s5">, </span><span class="s1">now</span><span class="s5"> + </span><span class="s1">attackTime</span><span class="s5"> + </span><span class="s1">decayTime</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Create multiple oscillators for richer timbre (additive synthesis)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Fundamental (using triangle for a softer piano sound)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">osc1</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createOscillator</span><span class="s5">();</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">osc1</span><span class="s5">.</span><span class="s14">type</span><span class="s5"> = </span><span class="s7">'triangle'</span><span class="s5">; </span><span class="s1">// Changed to triangle for softer tone</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">osc1</span><span class="s5">.</span><span class="s1">frequency</span><span class="s5">.</span><span class="s1">value</span><span class="s5"> = </span><span class="s1">fundamentalFreq</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">osc1</span><span class="s5">.</span><span class="s1">connect</span><span class="s5">(</span><span class="s1">masterGain</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">osc1</span><span class="s1">.</span><span class="s14">start</span><span class="s1">(</span><span class="s14">now</span><span class="s1">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">activeOscillators</span><span class="s5">.</span><span class="s1">push</span><span class="s5">(</span><span class="s1">osc1</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Octave higher (subtle sine for brightness)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">osc2</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createOscillator</span><span class="s5">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">osc2</span><span class="s1">.</span><span class="s14">type</span><span class="s1"> = </span><span class="s7">'sine'</span><span class="s1">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">osc2</span><span class="s5">.</span><span class="s1">frequency</span><span class="s5">.</span><span class="s1">value</span><span class="s5"> = </span><span class="s1">fundamentalFreq</span><span class="s5"> * </span><span class="s6">2</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">gain2</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createGain</span><span class="s5">();</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gain2</span><span class="s5">.</span><span class="s14">gain</span><span class="s5">.</span><span class="s14">value</span><span class="s5"> = </span><span class="s6">0.2</span><span class="s5">; </span><span class="s1">// Slightly reduced volume for brightness</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">osc2</span><span class="s5">.</span><span class="s1">connect</span><span class="s5">(</span><span class="s1">gain2</span><span class="s5">).</span><span class="s1">connect</span><span class="s5">(</span><span class="s1">masterGain</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">osc2</span><span class="s1">.</span><span class="s14">start</span><span class="s1">(</span><span class="s14">now</span><span class="s1">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">activeOscillators</span><span class="s5">.</span><span class="s1">push</span><span class="s5">(</span><span class="s1">osc2</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Fifth higher (even more subtle sine)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">osc3</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createOscillator</span><span class="s5">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">osc3</span><span class="s1">.</span><span class="s14">type</span><span class="s1"> = </span><span class="s7">'sine'</span><span class="s1">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">osc3</span><span class="s5">.</span><span class="s1">frequency</span><span class="s5">.</span><span class="s1">value</span><span class="s5"> = </span><span class="s1">fundamentalFreq</span><span class="s5"> * </span><span class="s6">1.5</span><span class="s5">; </span><span class="s11">// Approx perfect fifth</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">gain3</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createGain</span><span class="s5">();</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gain3</span><span class="s5">.</span><span class="s14">gain</span><span class="s5">.</span><span class="s14">value</span><span class="s5"> = </span><span class="s6">0.1</span><span class="s5">; </span><span class="s1">// Further reduced volume</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">osc3</span><span class="s5">.</span><span class="s1">connect</span><span class="s5">(</span><span class="s1">gain3</span><span class="s5">).</span><span class="s1">connect</span><span class="s5">(</span><span class="s1">masterGain</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">osc3</span><span class="s1">.</span><span class="s14">start</span><span class="s1">(</span><span class="s14">now</span><span class="s1">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">activeOscillators</span><span class="s5">.</span><span class="s1">push</span><span class="s5">(</span><span class="s1">osc3</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Schedule the release and stop of oscillators</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">noteDuration</span><span class="s5"> = </span><span class="s6">1.5</span><span class="s5">; </span><span class="s1">// Total active duration before release starts</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">masterGain</span><span class="s5">.</span><span class="s1">gain</span><span class="s5">.</span><span class="s1">linearRampToValueAtTime</span><span class="s5">(</span><span class="s6">0.0001</span><span class="s5">, </span><span class="s1">now</span><span class="s5"> + </span><span class="s1">noteDuration</span><span class="s5"> + </span><span class="s1">releaseTime</span><span class="s5">); </span><span class="s11">// Release</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Stop all oscillators after total duration + a bit of buffer</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">activeOscillators</span><span class="s5">.</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">osc</span><span class="s5"> =&gt; {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">osc</span><span class="s5">.</span><span class="s1">stop</span><span class="s5">(</span><span class="s1">now</span><span class="s5"> + </span><span class="s1">noteDuration</span><span class="s5"> + </span><span class="s1">releaseTime</span><span class="s5"> + </span><span class="s6">0.1</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Pitch detection using a simplified Autocorrelation method.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* This algorithm attempts to find the fundamental frequency by correlating the signal with itself at various lags.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* It prioritizes stronger correlations within a typical human vocal range.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {Float32Array} audioBuffer - Time domain audio data (e.g., from `event.inputBuffer.getChannelData(0)`).</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} sampleRate - AudioContext sample rate.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @returns {number} Detected frequency in Hz, or 0 if no reliable pitch is found.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">detectPitchAutocorrelation</span><span class="s5">(</span><span class="s1">audioBuffer</span><span class="s5">, </span><span class="s1">sampleRate</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">bufferLength</span><span class="s5"> = </span><span class="s1">audioBuffer</span><span class="s5">.</span><span class="s1">length</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s15">MIN_FREQ</span><span class="s5"> = </span><span class="s6">80</span><span class="s5">;<span class="Apple-converted-space">  </span></span><span class="s1">// Hz: Minimum expected human vocal frequency (approx G2)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s15">MAX_FREQ</span><span class="s5"> = </span><span class="s6">700</span><span class="s5">; </span><span class="s1">// Hz: Maximum expected human vocal frequency (approx F5, higher for sopranos)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">maxCorrelation</span><span class="s5"> = </span><span class="s4">new</span><span class="s5"> </span><span class="s15">Array</span><span class="s5">(</span><span class="s1">bufferLength</span><span class="s5">).</span><span class="s1">fill</span><span class="s5">(</span><span class="s6">0</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Compute the autocorrelation values for different lags.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Autocorrelation at lag 'i' measures how similar the signal is to itself when shifted by 'i' samples.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">for</span><span class="s1"> (</span><span class="s4">let</span><span class="s1"> </span><span class="s14">i</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">; </span><span class="s14">i</span><span class="s1"> &lt; </span><span class="s14">bufferLength</span><span class="s1">; </span><span class="s14">i</span><span class="s1">++) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">for</span><span class="s1"> (</span><span class="s4">let</span><span class="s1"> </span><span class="s14">j</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">; </span><span class="s14">j</span><span class="s1"> &lt; </span><span class="s14">bufferLength</span><span class="s1"> - </span><span class="s14">i</span><span class="s1">; </span><span class="s14">j</span><span class="s1">++) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">maxCorrelation</span><span class="s5">[</span><span class="s1">i</span><span class="s5">] += </span><span class="s1">audioBuffer</span><span class="s5">[</span><span class="s1">j</span><span class="s5">] * </span><span class="s1">audioBuffer</span><span class="s5">[</span><span class="s1">j</span><span class="s5"> + </span><span class="s1">i</span><span class="s5">];</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Find the strongest peak in the correlation buffer that corresponds to a human vocal pitch.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// We ignore initial lags (small 'i') because they correspond to high frequencies which might be noise</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// or the signal's own energy, not its fundamental periodicity.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">peakIndex</span><span class="s1"> = -</span><span class="s6">1</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">maxVal</span><span class="s1"> = -</span><span class="s6">1</span><span class="s1">;</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Calculate the minimum and maximum lag values corresponding to the MIN_FREQ and MAX_FREQ.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Lag = Sample Rate / Frequency. Higher frequency = smaller lag. Lower frequency = larger lag.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">minLag</span><span class="s5"> = </span><span class="s14">sampleRate</span><span class="s5"> / </span><span class="s15">MAX_FREQ</span><span class="s5">; </span><span class="s1">// Smallest lag to search (for highest vocal frequency)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">maxLag</span><span class="s5"> = </span><span class="s14">sampleRate</span><span class="s5"> / </span><span class="s15">MIN_FREQ</span><span class="s5">; </span><span class="s1">// Largest lag to search (for lowest vocal frequency)</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Iterate through the relevant lag range to find the strongest correlation peak.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">for</span><span class="s1"> (</span><span class="s4">let</span><span class="s1"> </span><span class="s14">i</span><span class="s1"> = </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">floor</span><span class="s1">(</span><span class="s14">minLag</span><span class="s1">); </span><span class="s14">i</span><span class="s1"> &lt;= </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">floor</span><span class="s1">(</span><span class="s14">maxLag</span><span class="s1">); </span><span class="s14">i</span><span class="s1">++) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Ensure 'i' is a valid index</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">i</span><span class="s1"> &gt;= </span><span class="s6">0</span><span class="s1"> &amp;&amp; </span><span class="s14">i</span><span class="s1"> &lt; </span><span class="s14">bufferLength</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">maxCorrelation</span><span class="s1">[</span><span class="s14">i</span><span class="s1">] &gt; </span><span class="s14">maxVal</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s14">maxVal</span><span class="s1"> = </span><span class="s14">maxCorrelation</span><span class="s1">[</span><span class="s14">i</span><span class="s1">];</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s14">peakIndex</span><span class="s1"> = </span><span class="s14">i</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Confidence threshold: The strength of the detected peak must be a significant fraction</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// of the signal's total energy (represented by autocorrelation at lag 0).</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// A lower threshold (e.g., 0.2) makes it more sensitive but potentially prone to picking up noise.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// A higher threshold (e.g., 0.7) makes it more robust but might miss softer or less clear voices.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">correlationConfidenceThreshold</span><span class="s5"> = </span><span class="s6">0.3</span><span class="s5">; </span><span class="s1">// Adjusted to be more forgiving for real-time human voice input</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// If no valid peak was found, or the peak is not strong enough relative to the total signal energy,</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// or if the signal has no energy (maxCorrelation[0] is zero, indicating silence), return 0.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">peakIndex</span><span class="s5"> === -</span><span class="s6">1</span><span class="s5"> || </span><span class="s1">maxCorrelation</span><span class="s5">[</span><span class="s6">0</span><span class="s5">] === </span><span class="s6">0</span><span class="s5"> || </span><span class="s1">maxVal</span><span class="s5"> &lt; (</span><span class="s1">correlationConfidenceThreshold</span><span class="s5"> * </span><span class="s1">maxCorrelation</span><span class="s5">[</span><span class="s6">0</span><span class="s5">])) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">return</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">// No reliable pitch detected or too quiet/noisy</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Refine the peak estimation using parabolic interpolation for better sub-sample accuracy.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// This helps in getting a more precise frequency value than just integer lag.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">peakIndex</span><span class="s1"> &gt; </span><span class="s6">0</span><span class="s1"> &amp;&amp; </span><span class="s14">peakIndex</span><span class="s1"> &lt; </span><span class="s14">bufferLength</span><span class="s1"> - </span><span class="s6">1</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">s0</span><span class="s1"> = </span><span class="s14">maxCorrelation</span><span class="s1">[</span><span class="s14">peakIndex</span><span class="s1"> - </span><span class="s6">1</span><span class="s1">]; </span><span class="s11">// Value at previous lag</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">s1</span><span class="s1"> = </span><span class="s14">maxCorrelation</span><span class="s1">[</span><span class="s14">peakIndex</span><span class="s1">]; <span class="Apple-converted-space">    </span></span><span class="s11">// Value at peak lag</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">s2</span><span class="s1"> = </span><span class="s14">maxCorrelation</span><span class="s1">[</span><span class="s14">peakIndex</span><span class="s1"> + </span><span class="s6">1</span><span class="s1">]; </span><span class="s11">// Value at next lag</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Parabolic interpolation formula to find a more precise peak location (non-integer).</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">peakIndex</span><span class="s1"> += (</span><span class="s14">s0</span><span class="s1"> - </span><span class="s14">s2</span><span class="s1">) / (</span><span class="s6">2</span><span class="s1"> * (</span><span class="s14">s0</span><span class="s1"> - </span><span class="s6">2</span><span class="s1"> * </span><span class="s14">s1</span><span class="s1"> + </span><span class="s14">s2</span><span class="s1">));</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Calculate the detected frequency using the refined peak index.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">detectedFrequency</span><span class="s5"> = </span><span class="s1">sampleRate</span><span class="s5"> / </span><span class="s1">peakIndex</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Final check to ensure the detected frequency is within the expected human vocal range.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">detectedFrequency</span><span class="s5"> &lt; </span><span class="s15">MIN_FREQ</span><span class="s5"> || </span><span class="s1">detectedFrequency</span><span class="s5"> &gt; </span><span class="s15">MAX_FREQ</span><span class="s5">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">return</span><span class="s5"> </span><span class="s6">0</span><span class="s5">; </span><span class="s1">// Out of valid range, likely noise or artifact</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">return</span><span class="s5"> </span><span class="s1">detectedFrequency</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Updates the volume meter bar based on the microphone input.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">updateVolumeMeter</span><span class="s5">() {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (!</span><span class="s14">analyser</span><span class="s1">) </span><span class="s4">return</span><span class="s1">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">bufferLength</span><span class="s5"> = </span><span class="s14">analyser</span><span class="s5">.</span><span class="s14">fftSize</span><span class="s5">; </span><span class="s1">// Use fftSize for time domain data</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">dataArray</span><span class="s5"> = </span><span class="s4">new</span><span class="s5"> </span><span class="s15">Uint8Array</span><span class="s5">(</span><span class="s14">bufferLength</span><span class="s5">); </span><span class="s1">// Unsigned byte for time domain</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">analyser</span><span class="s5">.</span><span class="s1">getByteTimeDomainData</span><span class="s5">(</span><span class="s1">dataArray</span><span class="s5">); </span><span class="s11">// Get the raw waveform data</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">sumSquares</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">for</span><span class="s1"> (</span><span class="s4">let</span><span class="s1"> </span><span class="s14">i</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">; </span><span class="s14">i</span><span class="s1"> &lt; </span><span class="s14">bufferLength</span><span class="s1">; </span><span class="s14">i</span><span class="s1">++) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">value</span><span class="s5"> = </span><span class="s14">dataArray</span><span class="s5">[</span><span class="s14">i</span><span class="s5">] - </span><span class="s6">128</span><span class="s5">; </span><span class="s1">// Center the values around 0 (midpoint of 0-255)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">sumSquares</span><span class="s1"> += </span><span class="s14">value</span><span class="s1"> * </span><span class="s14">value</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s5"> </span><span class="s14">rms</span><span class="s5"> = </span><span class="s15">Math</span><span class="s5">.</span><span class="s14">sqrt</span><span class="s5">(</span><span class="s14">sumSquares</span><span class="s5"> / </span><span class="s14">bufferLength</span><span class="s5">); </span><span class="s1">// Calculate RMS (Root Mean Square)</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Normalize RMS to a 0-100% range for the volume bar.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// The maximum theoretical RMS for an 8-bit signal is around 90.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Scaling by 60 provides a good visual range for typical voice levels.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">volumePercentage</span><span class="s1"> = </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">min</span><span class="s1">(</span><span class="s6">100</span><span class="s1">, (</span><span class="s14">rms</span><span class="s1"> / </span><span class="s6">60</span><span class="s1">) * </span><span class="s6">100</span><span class="s1">); </span><span class="s11">// Scale 0-60 RMS to 0-100%</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">volumeBar</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">width</span><span class="s5"> = </span><span class="s7">`</span><span class="s5">${</span><span class="s1">volumePercentage</span><span class="s5">}</span><span class="s7">%`</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Updates the pitch indicator marker position.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} detectedMidi - The MIDI note detected from the microphone.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} targetMidi - The target MIDI note for the current level.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} tolerance - The difficulty tolerance in semitones.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">updatePitchIndicator</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5">, </span><span class="s1">targetMidi</span><span class="s5">, </span><span class="s1">tolerance</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (!</span><span class="s1">pitchMarker</span><span class="s5"> || !</span><span class="s1">pitchIndicatorContainer</span><span class="s5">) </span><span class="s4">return</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// If in tuner mode, targetMidi doesn't exist for the game logic.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// We can define a fixed "reference" MIDI note for the tuner's visual range, e.g., C4 (60).</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">referenceMidi</span><span class="s5"> = </span><span class="s1">tunerModeActive</span><span class="s5"> ? </span><span class="s6">60</span><span class="s5"> : </span><span class="s1">targetMidi</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Define the visual range for the indicator, e.g., +/- 2 semitones around the target</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">visualRangeSemis</span><span class="s5"> = </span><span class="s6">2</span><span class="s5">; </span><span class="s1">// +/- 2 semitones from center of the visual indicator</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// This range should be relative to the *target* note in game mode, or a *reference* note in tuner mode.</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Calculate the deviation from the reference MIDI note (or target MIDI note in game mode)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">deviation</span><span class="s5"> = </span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">referenceMidi</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Normalize the deviation to a 0-1 range for positioning the marker</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Map the deviation from [-visualRangeSemis, visualRangeSemis] to [0, 1]</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">normalizedPosition</span><span class="s5"> = (</span><span class="s1">deviation</span><span class="s5"> + </span><span class="s1">visualRangeSemis</span><span class="s5">) / (</span><span class="s6">2</span><span class="s5"> * </span><span class="s1">visualRangeSemis</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">normalizedPosition</span><span class="s5"> = </span><span class="s15">Math</span><span class="s5">.</span><span class="s1">max</span><span class="s5">(</span><span class="s6">0</span><span class="s5">, </span><span class="s15">Math</span><span class="s5">.</span><span class="s1">min</span><span class="s5">(</span><span class="s6">1</span><span class="s5">, </span><span class="s1">normalizedPosition</span><span class="s5">)); </span><span class="s11">// Clamp between 0 and 1</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Convert to percentage for CSS left property</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">positionPercent</span><span class="s5"> = </span><span class="s1">normalizedPosition</span><span class="s5"> * </span><span class="s6">100</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">left</span><span class="s5"> = </span><span class="s7">`</span><span class="s5">${</span><span class="s1">positionPercent</span><span class="s5">}</span><span class="s7">%`</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Change marker color based on accuracy relative to target (only relevant in game mode)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">gameRunning</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetMidiLowerOctave</span><span class="s5"> = </span><span class="s1">targetMidi</span><span class="s5"> - </span><span class="s6">12</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetMidiHigherOctave</span><span class="s5"> = </span><span class="s1">targetMidi</span><span class="s5"> + </span><span class="s6">12</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Two octaves lower/higher (24 semitones)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetMidiLower24</span><span class="s5"> = </span><span class="s1">targetMidi</span><span class="s5"> - </span><span class="s6">24</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetMidiHigher24</span><span class="s5"> = </span><span class="s1">targetMidi</span><span class="s5"> + </span><span class="s6">24</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">isCorrectPitch</span><span class="s1"> =</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s1">.</span><span class="s14">abs</span><span class="s1">(</span><span class="s14">detectedMidi</span><span class="s1"> - </span><span class="s14">targetMidi</span><span class="s1">) &lt;= </span><span class="s14">tolerance</span><span class="s1">) || </span><span class="s11">// Exact pitch</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiLowerOctave</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// One octave lower</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiHigherOctave</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// One octave higher</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiLower24</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// Two octaves lower</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiHigher24</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">); </span><span class="s11">// Two octaves higher</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">isCorrectPitch</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#4CAF50'</span><span class="s5">; </span><span class="s11">// Green (Correct)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s4">else</span><span class="s1"> </span><span class="s4">if</span><span class="s1"> (</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s1">.</span><span class="s14">abs</span><span class="s1">(</span><span class="s14">detectedMidi</span><span class="s1"> - </span><span class="s14">targetMidi</span><span class="s1">) &lt;= (</span><span class="s14">tolerance</span><span class="s1"> + </span><span class="s6">1</span><span class="s1">)) || </span><span class="s11">// Slightly outside tolerance for target</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s14">abs</span><span class="s5">(</span><span class="s14">detectedMidi</span><span class="s5"> - </span><span class="s14">targetMidiLowerOctave</span><span class="s5">) &lt;= (</span><span class="s14">tolerance</span><span class="s5"> + </span><span class="s6">1</span><span class="s5">)) || </span><span class="s1">// Slightly outside tolerance for lower octave</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s14">abs</span><span class="s5">(</span><span class="s14">detectedMidi</span><span class="s5"> - </span><span class="s14">targetMidiHigherOctave</span><span class="s5">) &lt;= (</span><span class="s14">tolerance</span><span class="s5"> + </span><span class="s6">1</span><span class="s5">)) || </span><span class="s1">// Slightly outside tolerance for higher octave</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s14">abs</span><span class="s5">(</span><span class="s14">detectedMidi</span><span class="s5"> - </span><span class="s14">targetMidiLower24</span><span class="s5">) &lt;= (</span><span class="s14">tolerance</span><span class="s5"> + </span><span class="s6">1</span><span class="s5">)) || </span><span class="s1">// Slightly outside tolerance for two octaves lower</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s14">abs</span><span class="s5">(</span><span class="s14">detectedMidi</span><span class="s5"> - </span><span class="s14">targetMidiHigher24</span><span class="s5">) &lt;= (</span><span class="s14">tolerance</span><span class="s5"> + </span><span class="s6">1</span><span class="s5">)) </span><span class="s1">// Slightly outside tolerance for two octaves higher</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#FFEB3B'</span><span class="s5">; </span><span class="s11">// Yellow (Close)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#F44336'</span><span class="s5">; </span><span class="s11">// Red (Far)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s5"> { </span><span class="s1">// Tuner mode, no specific target to be "correct"</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Simple color logic for tuner: green for "around A4", yellow for close, red for far</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">tunerCenterMidi</span><span class="s1"> = </span><span class="s6">69</span><span class="s1">; </span><span class="s11">// A4</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">tunerCloseTolerance</span><span class="s5"> = </span><span class="s6">0.5</span><span class="s5">; </span><span class="s1">// +/- 0.5 semitones for "green"</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">tunerFarTolerance</span><span class="s5"> = </span><span class="s6">2</span><span class="s5">; </span><span class="s1">// +/- 2 semitones for "yellow"</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">absDevTuner</span><span class="s5"> = </span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">tunerCenterMidi</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">absDevTuner</span><span class="s5"> &lt;= </span><span class="s1">tunerCloseTolerance</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#4CAF50'</span><span class="s5">; </span><span class="s11">// Green</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s4">else</span><span class="s1"> </span><span class="s4">if</span><span class="s1"> (</span><span class="s14">absDevTuner</span><span class="s1"> &lt;= </span><span class="s14">tunerFarTolerance</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#FFEB3B'</span><span class="s5">; </span><span class="s11">// Yellow</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#F44336'</span><span class="s5">; </span><span class="s11">// Red</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Initializes microphone input and Web Audio API components.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">async</span><span class="s5"> </span><span class="s4">function</span><span class="s5"> </span><span class="s1">setupMicrophone</span><span class="s5">() {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">microphone</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">audioContext</span><span class="s1"> &amp;&amp; </span><span class="s14">audioContext</span><span class="s1">.</span><span class="s14">state</span><span class="s1"> === </span><span class="s7">'suspended'</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s4">await</span><span class="s1"> </span><span class="s14">audioContext</span><span class="s1">.</span><span class="s14">resume</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">return</span><span class="s1">; </span><span class="s11">// Already set up</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">try</span><span class="s1"> {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">audioContext</span><span class="s5"> = </span><span class="s4">new</span><span class="s5"> (</span><span class="s1">window</span><span class="s5">.</span><span class="s15">AudioContext</span><span class="s5"> || </span><span class="s1">window</span><span class="s5">.</span><span class="s1">webkitAudioContext</span><span class="s5">)();</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">stream</span><span class="s5"> = </span><span class="s4">await</span><span class="s5"> </span><span class="s1">navigator</span><span class="s5">.</span><span class="s1">mediaDevices</span><span class="s5">.</span><span class="s1">getUserMedia</span><span class="s5">({ </span><span class="s1">audio</span><span class="s5">: </span><span class="s4">true</span><span class="s5"> });</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">microphone</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createMediaStreamSource</span><span class="s5">(</span><span class="s1">stream</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">analyser</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createAnalyser</span><span class="s5">();</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">analyser</span><span class="s5">.</span><span class="s14">fftSize</span><span class="s5"> = </span><span class="s6">2048</span><span class="s5">; </span><span class="s1">// Size of FFT window for frequency data</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">analyser</span><span class="s5">.</span><span class="s14">minDecibels</span><span class="s5"> = -</span><span class="s6">90</span><span class="s5">; </span><span class="s1">// Minimum decibels for range</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">analyser</span><span class="s5">.</span><span class="s14">maxDecibels</span><span class="s5"> = -</span><span class="s6">10</span><span class="s5">; </span><span class="s1">// Maximum decibels for range</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">analyser</span><span class="s5">.</span><span class="s14">smoothingTimeConstant</span><span class="s5"> = </span><span class="s6">0.85</span><span class="s5">; </span><span class="s1">// Smooths out the visualization</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">scriptProcessor</span><span class="s5"> = </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">createScriptProcessor</span><span class="s5">(</span><span class="s6">4096</span><span class="s5">, </span><span class="s6">1</span><span class="s5">, </span><span class="s6">1</span><span class="s5">); </span><span class="s11">// bufferSize, inputChannels, outputChannels</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s5">.</span><span class="s14">connect</span><span class="s5">(</span><span class="s14">analyser</span><span class="s5">); </span><span class="s1">// Connect microphone to analyser</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">analyser</span><span class="s5">.</span><span class="s14">connect</span><span class="s5">(</span><span class="s14">scriptProcessor</span><span class="s5">); </span><span class="s1">// Connect analyser to scriptProcessor for data access</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">scriptProcessor</span><span class="s5">.</span><span class="s14">connect</span><span class="s5">(</span><span class="s14">audioContext</span><span class="s5">.</span><span class="s14">destination</span><span class="s5">); </span><span class="s1">// Connect scriptProcessor to audio destination (required for onaudioprocess to fire consistently)</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">scriptProcessor</span><span class="s5">.</span><span class="s1">onaudioprocess</span><span class="s5"> = (</span><span class="s1">event</span><span class="s5">) =&gt; {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">// This function runs whenever the audio input buffer is processed.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s4">if</span><span class="s5"> (!</span><span class="s14">guessMode</span><span class="s5">) { </span><span class="s1">// Only process microphone input if not in guess mode</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s14">updateVolumeMeter</span><span class="s5">(); </span><span class="s1">// Update the volume bar visually</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">buffer</span><span class="s5"> = </span><span class="s14">event</span><span class="s5">.</span><span class="s14">inputBuffer</span><span class="s5">.</span><span class="s14">getChannelData</span><span class="s5">(</span><span class="s6">0</span><span class="s5">); </span><span class="s1">// Get audio data from the first channel</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">sampleRate</span><span class="s5"> = </span><span class="s14">audioContext</span><span class="s5">.</span><span class="s14">sampleRate</span><span class="s5">; </span><span class="s1">// Get current audio context sample rate</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                        </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">frequency</span><span class="s5"> = </span><span class="s1">detectPitchAutocorrelation</span><span class="s5">(</span><span class="s1">buffer</span><span class="s5">, </span><span class="s1">sampleRate</span><span class="s5">); </span><span class="s11">// Use the improved pitch detection</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">frequency</span><span class="s1"> &gt; </span><span class="s6">0</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">detectedMidi</span><span class="s1"> = </span><span class="s14">freqToMidi</span><span class="s1">(</span><span class="s14">frequency</span><span class="s1">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                            </span></span><span class="s1">detectedNoteDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">midiNoteToName</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5">); </span><span class="s11">// Display detected note</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                            </span></span><span class="s1">updatePitchIndicator</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5">, </span><span class="s1">targetMidiNote</span><span class="s5">, </span><span class="s1">currentTolerance</span><span class="s5">); </span><span class="s11">// Update pitch indicator</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                            </span></span><span class="s1">// Only check for game passing/failing if in game mode, actively running, and countdown is active</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">gameRunning</span><span class="s1"> &amp;&amp; </span><span class="s14">countdownValue</span><span class="s1"> &gt; </span><span class="s6">0</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                                </span></span><span class="s14">checkPitch</span><span class="s1">(</span><span class="s14">detectedMidi</span><span class="s1">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                            </span></span><span class="s14">detectedNoteDisplay</span><span class="s5">.</span><span class="s14">textContent</span><span class="s5"> = </span><span class="s7">'--'</span><span class="s5">; </span><span class="s1">// Display '--' if no pitch is detected</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s14">pitchMarker</span><span class="s1">.</span><span class="s14">style</span><span class="s1">.</span><span class="s14">left</span><span class="s1"> = </span><span class="s7">'50%'</span><span class="s1">; </span><span class="s11">// Reset marker to center</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                            </span></span><span class="s14">pitchMarker</span><span class="s1">.</span><span class="s14">style</span><span class="s1">.</span><span class="s14">backgroundColor</span><span class="s1"> = </span><span class="s7">'#fff'</span><span class="s1">; </span><span class="s11">// Reset color</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>};</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">micStatusDisplay</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Hide microphone status warning</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">startGameBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Enable the start game button</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">startTunerBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Enable the tuner button</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">volumeMeter</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show the volume meter</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">pitchIndicatorContainer</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show pitch indicator</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">catch</span><span class="s1"> (</span><span class="s14">err</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">console</span><span class="s1">.</span><span class="s14">error</span><span class="s1">(</span><span class="s7">"無法獲取麥克風權限:"</span><span class="s1">, </span><span class="s14">err</span><span class="s1">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">micStatusDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show microphone warning</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">micStatusDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">'無法獲取麥克風權限，請檢查瀏覽器設定。'</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">startGameBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">; </span><span class="s1">// Disable start game button if mic access fails</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">startTunerBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">; </span><span class="s1">// Disable tuner button if mic access fails</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">volumeMeter</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide volume meter</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">pitchIndicatorContainer</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide pitch indicator</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Sets the game difficulty based on user selection.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s1"> </span><span class="s14">setDifficulty</span><span class="s1">() {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">selectedDifficulty</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">querySelector</span><span class="s5">(</span><span class="s7">'input[name="difficulty"]:checked'</span><span class="s5">).</span><span class="s1">value</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">currentTolerance</span><span class="s5"> = </span><span class="s1">difficultyTolerance</span><span class="s5">[</span><span class="s1">selectedDifficulty</span><span class="s5">];</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Set the countdown duration based on difficulty</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">difficultyCountdown</span><span class="s5">[</span><span class="s1">selectedDifficulty</span><span class="s5">];</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">console</span><span class="s5">.</span><span class="s1">log</span><span class="s5">(</span><span class="s7">`難易度設定為: </span><span class="s5">${</span><span class="s1">selectedDifficulty</span><span class="s5">}</span><span class="s7">, 容忍度: </span><span class="s5">${</span><span class="s1">currentTolerance</span><span class="s5">}</span><span class="s7"> 半音, 倒數: </span><span class="s5">${</span><span class="s1">difficultyCountdown</span><span class="s5">[</span><span class="s1">selectedDifficulty</span><span class="s5">]}</span><span class="s7"> 秒`</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Resets UI elements specific to mic input display.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">resetMicDisplay</span><span class="s5">() {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">detectedNoteDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">'--'</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">left</span><span class="s5"> = </span><span class="s7">'50%'</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">pitchMarker</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">backgroundColor</span><span class="s5"> = </span><span class="s7">'#fff'</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">volumeBar</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">width</span><span class="s5"> = </span><span class="s7">'0%'</span><span class="s5">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Starts a new game or restarts an existing one.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s1"> </span><span class="s14">startGame</span><span class="s1">() {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">tunerModeActive</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Ensure tuner mode is off</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">; </span><span class="s1">// Set game state to running</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">setDifficulty</span><span class="s5">(); </span><span class="s1">// Set difficulty for game mode, which also sets initial countdown</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">guessMode</span><span class="s5"> = </span><span class="s1">guessModeToggle</span><span class="s5">.</span><span class="s1">checked</span><span class="s5">; </span><span class="s11">// Check guess mode state</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Show/hide relevant elements for game mode</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">micInputArea</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">toggle</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">, </span><span class="s1">guessMode</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">guessModeArea</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">toggle</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">, !</span><span class="s1">guessMode</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">targetNoteDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">targetNoteLabel</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">toggle</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">, </span><span class="s1">guessMode</span><span class="s5">); </span><span class="s11">// Countdown only in mic game mode</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">progressBar</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show progress bar</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">currentLevelText</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show level text</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">playNoteBtn</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show play note button</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">returnToMainBtn</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Hide return button in game mode</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Show/hide mic indicators if mic mode is active</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">volumeMeter</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">toggle</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">, </span><span class="s1">guessMode</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">pitchIndicatorContainer</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">toggle</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">, </span><span class="s1">guessMode</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">startScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">gameScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">endScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">modeDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">'遊戲模式:'</span><span class="s5">; </span><span class="s11">// Update mode display</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">currentLevel</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">score</span><span class="s1"> = </span><span class="s6">0</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">resetMicDisplay</span><span class="s5">(); </span><span class="s1">// Reset mic display</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">nextLevel</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Starts the Tuner Mode.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">async</span><span class="s1"> </span><span class="s4">function</span><span class="s1"> </span><span class="s14">startTunerMode</span><span class="s1">() {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">tunerModeActive</span><span class="s1"> = </span><span class="s4">true</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Ensure game mode is off</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">guessMode</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Tuner mode always uses mic</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Stop any active countdown from previous game if it was running</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">countdownTimer</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">countdownDisplay</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Always hide countdown in tuner mode</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Show/hide relevant elements for tuner mode</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">micInputArea</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">guessModeArea</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Hide guess mode if somehow active</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">targetNoteDisplay</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Hide target note in tuner mode</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">targetNoteLabel</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">progressBar</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide progress bar</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">currentLevelText</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide level text</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">playNoteBtn</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Hide play note button</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">returnToMainBtn</span><span class="s5">.</span><span class="s14">classList</span><span class="s5">.</span><span class="s14">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s1">// Show return button in tuner mode</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">volumeMeter</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">pitchIndicatorContainer</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">startScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">gameScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">endScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">modeDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">'調音器模式'</span><span class="s5">; </span><span class="s11">// Update mode display</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">resetMicDisplay</span><span class="s5">(); </span><span class="s1">// Reset mic display for tuner</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">''</span><span class="s5">; </span><span class="s11">// Clear feedback</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">await</span><span class="s5"> </span><span class="s14">setupMicrophone</span><span class="s5">(); </span><span class="s1">// Ensure mic is set up for tuner</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// No levels or countdown in tuner mode, just continuous detection.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Proceeds to the next game level.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s1"> </span><span class="s14">nextLevel</span><span class="s1">() {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// If in tuner mode, don't proceed with game levels.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">tunerModeActive</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">return</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">currentLevel</span><span class="s1">++;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">currentLevel</span><span class="s1"> &gt; </span><span class="s6">10</span><span class="s1">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">endGame</span><span class="s5">(); </span><span class="s1">// If all levels completed, end game</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">return</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Clear any active countdown timer</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">countdownTimer</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Reset UI for new level</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">''</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">className</span><span class="s5"> = </span><span class="s7">'feedback-message mt-6'</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">resetMicDisplay</span><span class="s5">(); </span><span class="s1">// Reset mic display</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">currentLevelText</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">`第 </span><span class="s5">${</span><span class="s1">currentLevel</span><span class="s5">}</span><span class="s7"> / 10 關`</span><span class="s5">; </span><span class="s11">// Update current level display</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">progressBar</span><span class="s5">.</span><span class="s1">style</span><span class="s5">.</span><span class="s1">width</span><span class="s5"> = </span><span class="s7">`</span><span class="s5">${(</span><span class="s1">currentLevel</span><span class="s5"> - </span><span class="s6">1</span><span class="s5">) * </span><span class="s6">10</span><span class="s5">}</span><span class="s7">%`</span><span class="s5">; </span><span class="s11">// Update progress bar</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">targetMidiNote</span><span class="s5"> = </span><span class="s15">Math</span><span class="s5">.</span><span class="s14">floor</span><span class="s5">(</span><span class="s15">Math</span><span class="s5">.</span><span class="s14">random</span><span class="s5">() * (</span><span class="s6">72</span><span class="s5"> - </span><span class="s6">48</span><span class="s5"> + </span><span class="s6">1</span><span class="s5">)) + </span><span class="s6">48</span><span class="s5">; </span><span class="s1">// Generate a random MIDI note (C3 to C5)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (!</span><span class="s14">guessMode</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">targetNoteDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">midiNoteToName</span><span class="s5">(</span><span class="s1">targetMidiNote</span><span class="s5">); </span><span class="s11">// Display target note in mic mode</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">targetNoteDisplay</span><span class="s5">.</span><span class="s14">textContent</span><span class="s5"> = </span><span class="s7">'???'</span><span class="s5">; </span><span class="s1">// Hide target note in guess mode</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">playNoteBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Enable play note button</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (!</span><span class="s14">guessMode</span><span class="s1">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Get countdown duration based on current difficulty</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">selectedDifficulty</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">querySelector</span><span class="s5">(</span><span class="s7">'input[name="difficulty"]:checked'</span><span class="s5">).</span><span class="s1">value</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">startCountdown</span><span class="s5">(</span><span class="s1">difficultyCountdown</span><span class="s5">[</span><span class="s1">selectedDifficulty</span><span class="s5">]);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">generateGuessOptions</span><span class="s5">(); </span><span class="s1">// Generate guess options for guess mode</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Auto-play the note on new level to let the user hear it</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">playNote</span><span class="s5">(</span><span class="s1">targetMidiNote</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Starts the countdown for pitch detection based on difficulty.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} duration - The duration of the countdown in seconds.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">startCountdown</span><span class="s5">(</span><span class="s1">duration</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownValue</span><span class="s5"> = </span><span class="s1">duration</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">countdownValue</span><span class="s5">;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Ensure countdown is visible</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">countdownTimer</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">); </span><span class="s11">// Clear any existing timer</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownTimer</span><span class="s5"> = </span><span class="s1">setInterval</span><span class="s5">(() =&gt; {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">countdownValue</span><span class="s1">--;</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">countdownValue</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">countdownValue</span><span class="s1"> &lt;= </span><span class="s6">0</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">); </span><span class="s11">// Stop countdown</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide countdown</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">gameRunning</span><span class="s5">) { </span><span class="s1">// If game is still running (i.e., not already passed)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                        </span></span><span class="s14">showFailFeedback</span><span class="s1">(</span><span class="s7">"時間到！"</span><span class="s1">); </span><span class="s11">// Fail due to timeout</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span>}, </span><span class="s6">1000</span><span class="s5">); </span><span class="s1">// Update every 1 second</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Checks if the detected pitch from microphone matches the target pitch or its octaves.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* This function is called continuously from `scriptProcessor.onaudioprocess` when in mic mode.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} detectedMidi - The MIDI note detected from the microphone.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">checkPitch</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Only check for passing/failing if the game is running and countdown is active.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (!</span><span class="s1">gameRunning</span><span class="s5"> || </span><span class="s1">countdownValue</span><span class="s5"> &lt;= </span><span class="s6">0</span><span class="s5"> || </span><span class="s1">tunerModeActive</span><span class="s5">) </span><span class="s4">return</span><span class="s5">;</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetMidiLowerOctave</span><span class="s5"> = </span><span class="s1">targetMidiNote</span><span class="s5"> - </span><span class="s6">12</span><span class="s5">; </span><span class="s11">// One octave lower</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">targetMidiHigherOctave</span><span class="s5"> = </span><span class="s1">targetMidiNote</span><span class="s5"> + </span><span class="s6">12</span><span class="s5">; </span><span class="s11">// One octave higher</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Two octaves lower/higher (24 semitones)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">targetMidiLower24</span><span class="s5"> = </span><span class="s14">targetMidiNote</span><span class="s5"> - </span><span class="s6">24</span><span class="s5">; </span><span class="s1">// Two octaves lower (Major 17th)</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">targetMidiHigher24</span><span class="s5"> = </span><span class="s14">targetMidiNote</span><span class="s5"> + </span><span class="s6">24</span><span class="s5">; </span><span class="s1">// Two octaves higher (Major 17th)</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s14">tolerance</span><span class="s5"> = </span><span class="s14">currentTolerance</span><span class="s5">; </span><span class="s1">// Use the configured difficulty tolerance</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Check if the detected MIDI note is within a reasonable human vocal range</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">detectedMidi</span><span class="s5"> &gt; </span><span class="s6">0</span><span class="s5"> &amp;&amp; </span><span class="s14">detectedMidi</span><span class="s5"> &gt;= </span><span class="s6">30</span><span class="s5"> &amp;&amp; </span><span class="s14">detectedMidi</span><span class="s5"> &lt;= </span><span class="s6">90</span><span class="s5">) { </span><span class="s1">// MIDI notes roughly corresponding to G1 to C6</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Check against the exact target note and its octaves</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">isCorrectPitch</span><span class="s1"> =</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiNote</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// Exact pitch</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiLowerOctave</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// One octave lower</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiHigherOctave</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// One octave higher</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiLower24</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">) || </span><span class="s11">// Two octaves lower</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span>(</span><span class="s15">Math</span><span class="s5">.</span><span class="s1">abs</span><span class="s5">(</span><span class="s1">detectedMidi</span><span class="s5"> - </span><span class="s1">targetMidiHigher24</span><span class="s5">) &lt;= </span><span class="s1">tolerance</span><span class="s5">); </span><span class="s11">// Two octaves higher</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">                    </span></span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">isCorrectPitch</span><span class="s1">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s14">showSuccessFeedback</span><span class="s5">(); </span><span class="s1">// Pitch is correct (within tolerance for target or its octaves)</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">// In this continuous detection setup, immediate "fail" feedback for wrong pitch</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">// during the countdown might be too disruptive. Failure is primarily determined by timeout</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">// or a wrong guess in guess mode.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Generates and displays guess options for the guess pitch mode.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">generateGuessOptions</span><span class="s5">() {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">options</span><span class="s1"> = [];</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">options</span><span class="s5">.</span><span class="s14">push</span><span class="s5">(</span><span class="s14">targetMidiNote</span><span class="s5">); </span><span class="s1">// The correct answer is always one of the options</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Generate two incorrect but plausible options to make it a 3-choice quiz.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">while</span><span class="s1"> (</span><span class="s14">options</span><span class="s1">.</span><span class="s14">length</span><span class="s1"> &lt; </span><span class="s6">3</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">randomOffset</span><span class="s1"> = </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">floor</span><span class="s1">(</span><span class="s15">Math</span><span class="s1">.</span><span class="s14">random</span><span class="s1">() * </span><span class="s6">5</span><span class="s1">) + </span><span class="s6">1</span><span class="s1">; </span><span class="s11">// Offset by 1 to 5 semitones</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">let</span><span class="s1"> </span><span class="s14">sign</span><span class="s1"> = </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">random</span><span class="s1">() &lt; </span><span class="s6">0.5</span><span class="s1"> ? </span><span class="s6">1</span><span class="s1"> : -</span><span class="s6">1</span><span class="s1">; </span><span class="s11">// Randomly choose higher or lower</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">let</span><span class="s5"> </span><span class="s1">incorrectMidi</span><span class="s5"> = </span><span class="s1">targetMidiNote</span><span class="s5"> + (</span><span class="s1">randomOffset</span><span class="s5"> * </span><span class="s1">sign</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Ensure the incorrect note is within a reasonable playable range (C3 to C5 for consistency)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">incorrectMidi</span><span class="s5"> &lt; </span><span class="s6">48</span><span class="s5">) </span><span class="s1">incorrectMidi</span><span class="s5"> = </span><span class="s6">48</span><span class="s5"> + </span><span class="s1">randomOffset</span><span class="s5">; </span><span class="s11">// Adjust if too low</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">incorrectMidi</span><span class="s5"> &gt; </span><span class="s6">72</span><span class="s5">) </span><span class="s1">incorrectMidi</span><span class="s5"> = </span><span class="s6">72</span><span class="s5"> - </span><span class="s1">randomOffset</span><span class="s5">; </span><span class="s11">// Adjust if too high</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Ensure the generated incorrect note is not a duplicate and is actually different from the target.</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s5"> (!</span><span class="s1">options</span><span class="s5">.</span><span class="s1">includes</span><span class="s5">(</span><span class="s1">incorrectMidi</span><span class="s5">) &amp;&amp; </span><span class="s1">incorrectMidi</span><span class="s5"> !== </span><span class="s1">targetMidiNote</span><span class="s5">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">options</span><span class="s1">.</span><span class="s14">push</span><span class="s1">(</span><span class="s14">incorrectMidi</span><span class="s1">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Shuffle the options to randomize their display order on buttons</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s14">options</span><span class="s1">.</span><span class="s14">sort</span><span class="s1">(() =&gt; </span><span class="s15">Math</span><span class="s1">.</span><span class="s14">random</span><span class="s1">() - </span><span class="s6">0.5</span><span class="s1">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">const</span><span class="s5"> </span><span class="s1">guessOptionButtons</span><span class="s5"> = </span><span class="s1">document</span><span class="s5">.</span><span class="s1">querySelectorAll</span><span class="s5">(</span><span class="s7">'.guess-option-btn'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">guessOptionButtons</span><span class="s5">.</span><span class="s1">forEach</span><span class="s5">((</span><span class="s1">button</span><span class="s5">, </span><span class="s1">index</span><span class="s5">) =&gt; {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">const</span><span class="s1"> </span><span class="s14">midi</span><span class="s1"> = </span><span class="s14">options</span><span class="s1">[</span><span class="s14">index</span><span class="s1">];</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">button</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">midiNoteToName</span><span class="s5">(</span><span class="s1">midi</span><span class="s5">); </span><span class="s11">// Set button text to note name</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">button</span><span class="s5">.</span><span class="s14">dataset</span><span class="s5">.</span><span class="s14">midiNote</span><span class="s5"> = </span><span class="s14">midi</span><span class="s5">; </span><span class="s1">// Store MIDI note as data attribute</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">button</span><span class="s1">.</span><span class="s14">onclick</span><span class="s1"> = () =&gt; </span><span class="s14">checkGuess</span><span class="s1">(</span><span class="s14">midi</span><span class="s1">); </span><span class="s11">// Assign click event handler</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">button</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Ensure buttons are enabled for new turn</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>});</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Checks if the user's guessed pitch is correct in guess mode.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {number} selectedMidi - The MIDI note selected by the user.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">checkGuess</span><span class="s5">(</span><span class="s1">selectedMidi</span><span class="s5">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Disable all guess buttons after a selection to prevent multiple clicks</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">document</span><span class="s5">.</span><span class="s1">querySelectorAll</span><span class="s5">(</span><span class="s7">'.guess-option-btn'</span><span class="s5">).</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">btn</span><span class="s5"> =&gt; </span><span class="s1">btn</span><span class="s5">.</span><span class="s1">disabled</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">selectedMidi</span><span class="s5"> === </span><span class="s1">targetMidiNote</span><span class="s5">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">showSuccessFeedback</span><span class="s1">(); </span><span class="s11">// Correct guess</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">showFailFeedback</span><span class="s5">(</span><span class="s7">"猜錯了！"</span><span class="s5">); </span><span class="s1">// Incorrect guess (removed "請再試一次")</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Shows success feedback, increments score, and prepares for the next level.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">showSuccessFeedback</span><span class="s5">() {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">score</span><span class="s5">++; </span><span class="s1">// Increment score</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">'正確！'</span><span class="s5">; </span><span class="s11">// Display success message</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'feedback-fail'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'feedback-success'</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Pause game logic</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">countdownTimer</span><span class="s5">) { </span><span class="s1">// Stop countdown if active</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">passModal</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show pass modal</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Shows failure feedback and allows retrying the current level.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* @param {string} message - Optional message to display (e.g., "時間到！").</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s5"> </span><span class="s1">showFailFeedback</span><span class="s5">(</span><span class="s1">message</span><span class="s5"> = </span><span class="s7">"不正確。"</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">message</span><span class="s5">; </span><span class="s11">// Display failure message</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'feedback-success'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'feedback-fail'</span><span class="s5">);</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Pause game logic</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">countdownTimer</span><span class="s5">) { </span><span class="s1">// Stop countdown if active</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">failModal</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show fail modal</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">/**</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>* Ends the game, displays the final score, and resets to the start screen option.</span></p>
<p class="p5"><span class="s1"><span class="Apple-converted-space">         </span>*/</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s4">function</span><span class="s1"> </span><span class="s14">endGame</span><span class="s1">() {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Stop game logic</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">tunerModeActive</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Ensure tuner mode is off</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">gameScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide game screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">endScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show end screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">finalScoreDisplay</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s1">score</span><span class="s5">; </span><span class="s11">// Display final score</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s14">countdownTimer</span><span class="s5">) { </span><span class="s1">// Clear any remaining countdown timer</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">clearInterval</span><span class="s5">(</span><span class="s1">countdownTimer</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide countdown display</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Disconnect and clean up microphone resources if they were active</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">microphone</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s1">.</span><span class="s14">disconnect</span><span class="s1">();</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">scriptProcessor</span><span class="s5">.</span><span class="s1">disconnect</span><span class="s5">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">scriptProcessor</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Close and dispose of the AudioContext if it's running</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">audioContext</span><span class="s5"> &amp;&amp; </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">state</span><span class="s5"> === </span><span class="s7">'running'</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">close</span><span class="s5">().</span><span class="s1">then</span><span class="s5">(() =&gt; </span><span class="s1">audioContext</span><span class="s5"> = </span><span class="s4">null</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// --- Removed AI feedback function ---</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// getAiFeedback function removed as per user request.</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// --- Event Listeners ---</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">startGameBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, </span><span class="s1">startGame</span><span class="s5">); </span><span class="s11">// Start game when button clicked</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">startTunerBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, </span><span class="s1">startTunerMode</span><span class="s5">); </span><span class="s11">// Start Tuner Mode when button clicked</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">restartGameBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, () =&gt; {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">endScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">startScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Go back to start screen</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s14">returnFromEndBtn</span><span class="s5">.</span><span class="s14">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, () =&gt; { </span><span class="s1">// New event listener for return from end screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">endScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">startScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Ensure audio context is closed/suspended when returning to start screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">audioContext</span><span class="s5"> &amp;&amp; </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">state</span><span class="s5"> === </span><span class="s7">'running'</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">close</span><span class="s5">().</span><span class="s1">then</span><span class="s5">(() =&gt; </span><span class="s1">audioContext</span><span class="s5"> = </span><span class="s4">null</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">microphone</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s1">.</span><span class="s14">disconnect</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">scriptProcessor</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">scriptProcessor</span><span class="s5">.</span><span class="s1">disconnect</span><span class="s5">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">scriptProcessor</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">playNoteBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, () =&gt; {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">playNote</span><span class="s5">(</span><span class="s14">targetMidiNote</span><span class="s5">); </span><span class="s1">// Play the target note</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">playNoteBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">; </span><span class="s1">// Disable to prevent spamming</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">setTimeout</span><span class="s5">(() =&gt; </span><span class="s14">playNoteBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">, </span><span class="s6">1500</span><span class="s5">); </span><span class="s1">// Re-enable after 1.5 seconds</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Event listener for "下一關" on pass modal</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">nextLevelPassModalBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, () =&gt; {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">passModal</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide pass modal</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">; </span><span class="s1">// Resume game logic</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">nextLevel</span><span class="s5">(); </span><span class="s1">// Proceed to next level</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Event listener for "下一關" on fail modal</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">nextLevelFailModalBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, () =&gt; {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">failModal</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide fail modal</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">gameRunning</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">; </span><span class="s1">// Resume game logic</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">feedbackMessage</span><span class="s5">.</span><span class="s1">textContent</span><span class="s5"> = </span><span class="s7">''</span><span class="s5">; </span><span class="s11">// Clear feedback message</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">feedbackMessage</span><span class="s5">.</span><span class="s14">className</span><span class="s5"> = </span><span class="s7">'feedback-message mt-6'</span><span class="s5">; </span><span class="s1">// Reset feedback message class</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// In game mode, proceed to next level on fail.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// If it was guess mode, ensure guess buttons are re-enabled for the next level.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">guessMode</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                 </span></span><span class="s1">document</span><span class="s5">.</span><span class="s1">querySelectorAll</span><span class="s5">(</span><span class="s7">'.guess-option-btn'</span><span class="s5">).</span><span class="s1">forEach</span><span class="s5">(</span><span class="s1">btn</span><span class="s5"> =&gt; </span><span class="s1">btn</span><span class="s5">.</span><span class="s1">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">nextLevel</span><span class="s5">(); </span><span class="s1">// Always go to next level on fail</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Event listener for "返回主頁" button in tuner mode</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">returnToMainBtn</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'click'</span><span class="s5">, () =&gt; {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">gameScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide game screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">startScreen</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">remove</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Show start screen</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">tunerModeActive</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Turn off tuner mode</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Ensure audio context is closed/suspended when returning to start screen</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">audioContext</span><span class="s5"> &amp;&amp; </span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">state</span><span class="s5"> === </span><span class="s7">'running'</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">audioContext</span><span class="s5">.</span><span class="s1">close</span><span class="s5">().</span><span class="s1">then</span><span class="s5">(() =&gt; </span><span class="s1">audioContext</span><span class="s5"> = </span><span class="s4">null</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">microphone</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s1">.</span><span class="s14">disconnect</span><span class="s1">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">microphone</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">scriptProcessor</span><span class="s1">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">scriptProcessor</span><span class="s5">.</span><span class="s1">disconnect</span><span class="s5">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">scriptProcessor</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s14">resetMicDisplay</span><span class="s5">(); </span><span class="s1">// Clear mic displays</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Initialize microphone setup on window load to check permissions early.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// This helps provide a better user experience by asking for mic permission upfront if needed.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s14">window</span><span class="s1">.</span><span class="s14">onload</span><span class="s1"> = </span><span class="s4">function</span><span class="s1">() {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Initially disable tuner button until mic status is clear</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">startTunerBtn</span><span class="s5">.</span><span class="s1">disabled</span><span class="s5"> = </span><span class="s4">true</span><span class="s5">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// Only attempt to set up microphone if not in guess mode (default state)</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (!</span><span class="s1">guessModeToggle</span><span class="s5">.</span><span class="s1">checked</span><span class="s5">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">setupMicrophone</span><span class="s5">(); </span><span class="s1">// Attempt to setup microphone if not in guess mode</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// If guess mode is checked by default, enable start button directly</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">startGameBtn</span><span class="s1">.</span><span class="s14">disabled</span><span class="s1"> = </span><span class="s4">false</span><span class="s1">;</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">startTunerBtn</span><span class="s5">.</span><span class="s14">disabled</span><span class="s5"> = </span><span class="s4">false</span><span class="s5">; </span><span class="s1">// Also enable tuner button if mic is not strictly needed for initial setup</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>};</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">// Handle change in guess mode toggle: show/hide mic related elements and manage mic state</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">        </span></span><span class="s1">guessModeToggle</span><span class="s5">.</span><span class="s1">addEventListener</span><span class="s5">(</span><span class="s7">'change'</span><span class="s5">, () =&gt; {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// If we are currently in tuner mode, switch back to start screen logic first.</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s1">// This prevents issues where mic might be active and then toggled.</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">tunerModeActive</span><span class="s1">) {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">returnToMainBtn</span><span class="s5">.</span><span class="s14">click</span><span class="s5">(); </span><span class="s1">// Simulate clicking the return button</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">            </span></span><span class="s4">if</span><span class="s5"> (</span><span class="s1">guessModeToggle</span><span class="s5">.</span><span class="s1">checked</span><span class="s5">) {</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">micStatusDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">); </span><span class="s11">// Hide mic status</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s14">startGameBtn</span><span class="s1">.</span><span class="s14">disabled</span><span class="s1"> = </span><span class="s4">false</span><span class="s1">; </span><span class="s11">// Enable start button</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Disconnect mic if it was active and we're switching to a non-mic mode</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">microphone</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">microphone</span><span class="s1">.</span><span class="s14">disconnect</span><span class="s1">();</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                    </span></span><span class="s1">scriptProcessor</span><span class="s5">.</span><span class="s1">disconnect</span><span class="s5">();</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">microphone</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">scriptProcessor</span><span class="s1"> = </span><span class="s4">null</span><span class="s1">;</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span></span><span class="s4">if</span><span class="s1"> (</span><span class="s14">audioContext</span><span class="s1"> &amp;&amp; </span><span class="s14">audioContext</span><span class="s1">.</span><span class="s14">state</span><span class="s1"> === </span><span class="s7">'running'</span><span class="s1">) {</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                    </span></span><span class="s14">audioContext</span><span class="s1">.</span><span class="s14">suspend</span><span class="s1">(); </span><span class="s11">// Suspend audio context</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">                </span>}</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">// Hide mic-specific displays</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">countdownDisplay</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">volumeMeter</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p11"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s1">pitchIndicatorContainer</span><span class="s5">.</span><span class="s1">classList</span><span class="s5">.</span><span class="s1">add</span><span class="s5">(</span><span class="s7">'hidden'</span><span class="s5">);</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>} </span><span class="s4">else</span><span class="s1"> {</span></p>
<p class="p7"><span class="s5"><span class="Apple-converted-space">                </span></span><span class="s14">setupMicrophone</span><span class="s5">(); </span><span class="s1">// Setup microphone when switching back to mic mode</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">            </span>}</span></p>
<p class="p6"><span class="s1"><span class="Apple-converted-space">        </span>});</span></p>
<p class="p9"><span class="s12"></span><br></p>
<p class="p3"><span class="s5"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;/</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s3">&lt;/</span><span class="s1">html</span><span class="s3">&gt;</span></p>
<p class="p9"><span class="s12"></span><br></p>
</body>
</html>
